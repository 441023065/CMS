@using YangKai.BlogEngine.Modules.PostModule.Objects
@using YangKai.BlogEngine.ServiceProxy

@{
    Layout = "~/Views/Shared/_layout-whth-sidebar.cshtml";
    var channel = ViewBag.Channel as Channel;
    var group = ViewBag.Group as Group;
    var isAdmin = YangKai.BlogEngine.Common.WebMasterCookie.IsLogin.ToString().ToLower();
}

<script type="text/html" id="post-template">
    <li>
        @Html.Partial("post-title")
        @Html.Partial("post-header")
        @Html.Partial("post-body")
        @Html.Partial("post-footer")
    </li>
</script>

<div id="postnav">
    @if (group==null)
    {
        @channel.Name
    }
    else
    {
        <text>
        <a href="/@channel.Url">@channel.Name</a>
            &gt;
        @group.Name
        </text>
    }
</div>

@if (YangKai.BlogEngine.Common.WebMasterCookie.IsLogin)
{
<div id="addpost" class="_add"><a href="/admin/postmanage/new">添加新文章</a></div>
<div class="clear"></div>
}
@if (!string.IsNullOrEmpty(Request.QueryString["c"]))
{
    <div class="boxcaption"><h3>存档</h3></div>
    <div class="box">‘@(QueryFactory.Instance.Post.GetCategory(Request.QueryString["c"]).Name)’ 分类的存档</div>
}
@if (!string.IsNullOrEmpty(Request.QueryString["t"]))
{
    <div class="boxcaption"><h3>存档</h3></div>
    <div class="box">文章标签 ‘@Request.QueryString["t"]’</div>
}
else if (!string.IsNullOrEmpty(Request.QueryString["d"]))
{
    <div class="boxcaption"><h3>存档</h3></div>
    <div class="box">‘@Request.QueryString["d"]’ 分类的存档</div>
}
else if (!string.IsNullOrEmpty(Request.QueryString["k"]))
{
    <div class="boxcaption"><h3>搜索结果</h3></div>
    <div class="box">关键字:‘@Request.QueryString["k"]’</div>
}

<script type="text/javascript">
    function PostListViewModel(isadmin) {
        var self = this;
            
        self.authorized = isadmin;
        self.list = ko.observableArray();
        self.loading = ko.observable(true);
            
        self.TotalResults = ko.observable();
        self.Pager = ko.pager(self.TotalResults);
        self.Pager().CurrentPage.subscribe(function () {
            window.location = "#";
            self.turnpages(function () {
                //fadeOutAndFadeIn("div-list-loader", "div-list-templatecontainer");
            });
        });

        self.del = function() {
        };

        self.turnpages = function (callback) {
            //fadeOutAndFadeIn("div-list-templatecontainer", "div-list-loader");
            $.getJSON('/article/list?id=' + self.Pager().CurrentPage(), function (result) {
                self.list(result.data);
                self.TotalResults(result.count);
                //NoDataCheck(list(), "div-list-templatecontainer");
                if (callback != null) callback();
            });
        };
            
        self.turnpages(function () {
            //fadeOutAndFadeIn("div-list-loader", "div-list-templatecontainer");
        });
    }

    $(document).ready(function () {
        ko.applyBindings(new PostListViewModel(@isAdmin),$("#posts")[0]);
    });
</script>
    
<div id="posts">
    <ul data-bind="template: { name: 'post-template', foreach: list }"></ul>
    <div class="loading"><img src="/Content/Image/ajax-loader3.gif" /></div>
    @Html.Partial("_pager")
</div>

<style type="text/css">
    /*.loading {
        padding-top: 25%;
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        text-align: center;
        z-index: 20001;
        background-color: black;
        opacity: .70;
        filter: alpha(opacity = 70);
    }*/
</style>